<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국사 모의고사 생성기</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function KoreanHistoryQuiz() {
            const [apiKey, setApiKey] = useState('');
            const [range, setRange] = useState('');
            const [questionCount, setQuestionCount] = useState(10);
            const [selectedModel, setSelectedModel] = useState('gemini-3-flash-preview');
            const [questions, setQuestions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedAnswers, setSelectedAnswers] = useState({});
            const [showResults, setShowResults] = useState({});
            const [error, setError] = useState('');

            // API 키 로드 및 저장
            useEffect(() => {
                const savedApiKey = localStorage.getItem('gemini_api_key');
                if (savedApiKey) {
                    setApiKey(savedApiKey);
                }
            }, []);

            const handleApiKeyChange = (e) => {
                const newKey = e.target.value;
                setApiKey(newKey);
                if (newKey) {
                    localStorage.setItem('gemini_api_key', newKey);
                } else {
                    localStorage.removeItem('gemini_api_key');
                }
            };

            const generateQuestions = async () => {
                if (!apiKey) {
                    alert('Gemini API 키를 입력해주세요');
                    return;
                }

                if (questionCount < 1 || questionCount > 50) {
                    alert('문제 개수는 1개에서 50개 사이로 설정해주세요');
                    return;
                }

                setLoading(true);
                setQuestions([]);
                setSelectedAnswers({});
                setShowResults({});
                setError('');

                try {
                    const prompt = `한국사능력검정시험 대비 모의고사 문제를 ${questionCount}개 생성해주세요.
${range ? `범위: ${range}` : '전체 한국사 범위에서'}

반드시 아래 JSON 형식으로만 답변하세요. 다른 설명이나 마크다운 없이 순수 JSON만 출력하세요:

{
  "questions": [
    {
      "question": "문제 내용",
      "options": ["선택지1", "선택지2", "선택지3", "선택지4"],
      "correctAnswer": 0,
      "explanation": "정답 해설"
    }
  ]
}`;

                    // 모델별 설정
                    const modelConfigs = {
                        'gemini-3-flash-preview': {
                            temperature: 1.0,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 15000,
                            thinkingConfig: {
                                thinkingBudget: 3000
                            }
                        },
                        'gemini-3-pro-preview': {
                            temperature: 1.0,
                            topK: 64,
                            topP: 0.95,
                            maxOutputTokens: 15000,
                            thinkingConfig: {
                                thinkingBudget: 3000
                            }
                        }
                    };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: modelConfigs[selectedModel]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API 요청 실패');
                    }

                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (data.candidates && data.candidates[0]) {
                        let text = data.candidates[0].content.parts[0].text;
                        console.log('Raw text:', text);
                        
                        // JSON 코드 블록 제거
                        text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        
                        // JSON 파싱 시도
                        let parsed;
                        try {
                            parsed = JSON.parse(text);
                        } catch (parseError) {
                            console.error('Parse error:', parseError);
                            console.log('Failed text:', text);
                            throw new Error('JSON 파싱 실패. 다시 시도해주세요.');
                        }
                        
                        if (parsed.questions && Array.isArray(parsed.questions) && parsed.questions.length > 0) {
                            setQuestions(parsed.questions);
                        } else {
                            throw new Error('문제 형식이 올바르지 않습니다.');
                        }
                    } else {
                        throw new Error('API 응답에 문제가 있습니다.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setError(error.message);
                    alert(`오류: ${error.message}\n\nAPI 키가 올바른지, 인터넷 연결이 정상인지 확인해주세요.`);
                } finally {
                    setLoading(false);
                }
            };

            const handleAnswerSelect = (questionIndex, optionIndex) => {
                setSelectedAnswers({
                    ...selectedAnswers,
                    [questionIndex]: optionIndex
                });
            };

            const toggleShowResult = (questionIndex) => {
                setShowResults({
                    ...showResults,
                    [questionIndex]: !showResults[questionIndex]
                });
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                            <div className="flex items-center gap-3 mb-6">
                                <svg className="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                                <h1 className="text-3xl font-bold text-gray-800">한국사 모의고사 생성기</h1>
                            </div>

                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                                <p className="text-sm text-blue-700">
                                    <strong>선택된 모델:</strong> {selectedModel === 'gemini-3-flash-preview' ? 'Gemini 3.0 Flash Preview' : 'Gemini 3.0 Pro Preview'} | <strong>문제 개수:</strong> {questionCount}개
                                </p>
                            </div>

                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Gemini API 키
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={handleApiKeyChange}
                                        placeholder="API 키를 입력하세요 (자동 저장됨)"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">
                                            여기서 API 키 발급받기
                                        </a>
                                        {apiKey && <span className="ml-2 text-green-600">✓ 저장됨</span>}
                                    </p>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        AI 모델 선택
                                    </label>
                                    <div className="grid grid-cols-2 gap-3">
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                            selectedModel === 'gemini-3-flash-preview'
                                                ? 'border-indigo-500 bg-indigo-50'
                                                : 'border-gray-200 hover:border-indigo-300'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="model"
                                                value="gemini-3-flash-preview"
                                                checked={selectedModel === 'gemini-3-flash-preview'}
                                                onChange={(e) => setSelectedModel(e.target.value)}
                                                className="w-4 h-4 text-indigo-600"
                                            />
                                            <div>
                                                <div className="font-medium text-gray-800">Gemini 3.0 Flash</div>
                                                <div className="text-xs text-gray-500">빠르고 효율적</div>
                                            </div>
                                        </label>
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                            selectedModel === 'gemini-3-pro-preview'
                                                ? 'border-indigo-500 bg-indigo-50'
                                                : 'border-gray-200 hover:border-indigo-300'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="model"
                                                value="gemini-3-pro-preview"
                                                checked={selectedModel === 'gemini-3-pro-preview'}
                                                onChange={(e) => setSelectedModel(e.target.value)}
                                                className="w-4 h-4 text-indigo-600"
                                            />
                                            <div>
                                                <div className="font-medium text-gray-800">Gemini 3.0 Pro</div>
                                                <div className="text-xs text-gray-500">고급 추론</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        문제 개수
                                    </label>
                                    <input
                                        type="number"
                                        value={questionCount}
                                        onChange={(e) => setQuestionCount(Math.max(1, Math.min(50, parseInt(e.target.value) || 1)))}
                                        min="1"
                                        max="50"
                                        placeholder="1~50개"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">1개에서 50개 사이로 설정 가능합니다</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        문제 범위 (선택사항)
                                    </label>
                                    <input
                                        type="text"
                                        value={range}
                                        onChange={(e) => setRange(e.target.value)}
                                        placeholder="예: 조선시대, 고려시대, 근현대사, 삼국시대 등"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>

                                <button
                                    onClick={generateQuestions}
                                    disabled={loading}
                                    className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    {loading ? (
                                        <>
                                            <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            문제 생성 중... (약 {Math.ceil(questionCount / 2)}-{Math.ceil(questionCount)}초 소요)
                                        </>
                                    ) : (
                                        <>
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                            새로운 문제 {questionCount}개 생성
                                        </>
                                    )}
                                </button>

                                {error && (
                                    <div className="bg-red-50 border-l-4 border-red-500 p-4">
                                        <p className="text-sm text-red-700">{error}</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {questions.length > 0 && (
                            <div className="space-y-6">
                                {questions.map((q, qIndex) => (
                                    <div key={qIndex} className="bg-white rounded-lg shadow-lg p-6">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">
                                            {qIndex + 1}. {q.question}
                                        </h3>

                                        <div className="space-y-3 mb-4">
                                            {q.options.map((option, oIndex) => (
                                                <label
                                                    key={oIndex}
                                                    className={`flex items-start gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                                        selectedAnswers[qIndex] === oIndex
                                                            ? 'border-indigo-500 bg-indigo-50'
                                                            : 'border-gray-200 hover:border-indigo-300'
                                                    }`}
                                                >
                                                    <input
                                                        type="radio"
                                                        name={`question-${qIndex}`}
                                                        checked={selectedAnswers[qIndex] === oIndex}
                                                        onChange={() => handleAnswerSelect(qIndex, oIndex)}
                                                        className="mt-1 w-4 h-4 text-indigo-600"
                                                    />
                                                    <span className="text-gray-700">{option}</span>
                                                </label>
                                            ))}
                                        </div>

                                        <button
                                            onClick={() => toggleShowResult(qIndex)}
                                            disabled={selectedAnswers[qIndex] === undefined}
                                            className="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors disabled:bg-gray-50 disabled:text-gray-400 disabled:cursor-not-allowed"
                                        >
                                            {showResults[qIndex] ? '정답 숨기기' : '정답 확인'}
                                        </button>

                                        {showResults[qIndex] && (
                                            <div className="mt-4 p-4 rounded-lg bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-indigo-500">
                                                <div className="flex items-center gap-2 mb-2">
                                                    {selectedAnswers[qIndex] === q.correctAnswer ? (
                                                        <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                    ) : (
                                                        <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                    )}
                                                    <span className={`font-semibold ${
                                                        selectedAnswers[qIndex] === q.correctAnswer ? 'text-green-600' : 'text-red-600'
                                                    }`}>
                                                        {selectedAnswers[qIndex] === q.correctAnswer ? '정답입니다!' : '오답입니다'}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-600 mb-1">
                                                    <strong>정답:</strong> {q.options[q.correctAnswer]}
                                                </p>
                                                <p className="text-sm text-gray-700">
                                                    <strong>해설:</strong> {q.explanation}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {questions.length === 0 && !loading && (
                            <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                                <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                                <p className="text-gray-500">API 키를 입력하고 문제 개수와 범위를 설정한 후,<br/>"새로운 문제 생성" 버튼을 눌러주세요!</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<KoreanHistoryQuiz />);
    </script>
</body>
</html>